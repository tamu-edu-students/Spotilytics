<% content_for :extra_css do %>
  <%= stylesheet_link_tag "listening_patterns", media: "all" %>
<% end %>

<main class="container listening-patterns mt-4">
  <div class="page-heading d-flex flex-column flex-lg-row align-items-lg-center justify-content-lg-between">
    <div>
      <p class="eyebrow text-uppercase mb-1">Monthly Listening</p>
      <h1 class="text-light mb-2">Hours you've spent by month</h1>
      <p class="text-secondary mb-0">
        Totals are based on your track durations from Spotify’s Recently Played history.
        Times are shown in <%= Time.zone.name || "UTC" %>.
      </p>
    </div>

    <div class="d-flex align-items-center gap-3 mt-3 mt-lg-0">
      <%= form_with url: listening_monthly_path, method: :get, local: true, class: "d-flex align-items-center gap-2 limit-form" do %>
        <label class="text-secondary fw-semibold">Use last</label>
        <%= select_tag :limit,
              options_for_select([
                ["200 plays", 200],
                ["500 plays", 500],
                ["1000 plays", 1000]
              ], @limit),
              class: "form-select form-select-sm bg-dark text-white border-secondary",
              onchange: "this.form.submit();" %>
        <button class="btn btn-dark btn-sm js-hidden" type="submit">↻</button>
      <% end %>

      <div class="total-chip text-light">
        <span class="label text-secondary">Total hours</span>
        <span class="value text-light"><%= number_with_precision(@total_hours, precision: 1) %></span>
      </div>
    </div>
  </div>

  <% if @chart_data.present? && @buckets.present? %>
    <div class="row mt-4">
      <div class="col-12 col-lg-8 mb-4">
        <div class="spotify-card p-3 h-100 chart-card">
          <div class="d-flex justify-content-between align-items-start mb-2">
            <div>
              <h5 class="text-light mb-1">Hours listened per month</h5>
              <% if @history_window.present? %>
                <% start_time, end_time = @history_window %>
                <p class="text-secondary small mb-0">
                  Window: <%= start_time.strftime("%b %-d, %l:%M %p %Z") %> – <%= end_time.strftime("%b %-d, %l:%M %p %Z") %>
                </p>
              <% end %>
            </div>
            <span class="badge bg-success-subtle text-success-emphasis">
              Live from your Spotify history
            </span>
          </div>

          <div class="chart-wrapper">
            <canvas id="monthlyChart" width="680" height="340" aria-label="Monthly listening chart" role="img"></canvas>
          </div>
          <p class="text-secondary small mt-2 mb-0">
            Bars show how many hours of music you listened to each month, using the track durations from your last <%= @sample_size %> plays.
          </p>
        </div>
      </div>

      <div class="col-12 col-lg-4 mb-4">
        <div class="spotify-card p-3 h-100 stats-card d-flex flex-column gap-3">
          <div class="bg-dark-subtle p-3 rounded">
            <p class="text-light mb-1 fw-semibold">Previous month</p>
            <% if @previous_month.present? %>
              <p class="text-secondary mb-1">
                <%= @previous_month[:label] %> ·
                <strong class="text-light"><%= number_with_precision(@previous_month[:hours], precision: 1) %> hrs</strong>
              </p>
              <p class="text-secondary small mb-0">
                <%= @previous_month[:play_count] %> plays in that month.
              </p>
            <% else %>
              <p class="text-secondary mb-0">No data for the last full month yet.</p>
            <% end %>
          </div>

          <div>
            <h5 class="text-light mb-2">Month-by-month</h5>
            <ul class="list-unstyled mb-0">
              <% @buckets.each do |bucket| %>
                <li class="d-flex justify-content-between align-items-center stat-row">
                  <div class="d-flex align-items-center gap-2">
                    <span class="text-light fw-semibold"><%= bucket[:label] %></span>
                  </div>
                  <div class="text-end">
                    <div class="text-secondary"><%= number_with_precision(bucket[:hours], precision: 1) %> hrs</div>
                    <div class="text-secondary small"><%= bucket[:play_count] %> plays</div>
                  </div>
                </li>
              <% end %>
            </ul>
          </div>

          <div class="insight bg-dark-subtle p-3 rounded">
            <p class="text-light mb-1 fw-semibold">How this works</p>
            <p class="text-secondary small mb-0">
              We fetch your recent plays directly from Spotify and sum the track durations by calendar month to keep tabs on your listening time.
            </p>
          </div>
        </div>
      </div>
    </div>
  <% else %>
    <div class="spotify-card p-4 mt-4">
      <h5 class="text-light">No listening time yet</h5>
      <p class="text-secondary mb-2">
        Play some tracks on Spotify, then refresh to see how your monthly hours add up.
      </p>
      <%= link_to "Refresh", listening_monthly_path, class: "btn btn-spotify" %>
    </div>
  <% end %>
</main>

<% if @chart_data.present? && @buckets.present? %>
  <script type="application/json" id="monthlyData"><%= raw(@chart_data.to_json) %></script>
  <script>
    (function() {
      function renderMonthlyChart() {
        var canvas = document.getElementById('monthlyChart');
        if (!canvas) { return; }
        if (!window.Chart) { return setTimeout(renderMonthlyChart, 50); }

        var data = JSON.parse(document.getElementById('monthlyData').textContent);
        var ctx = canvas.getContext('2d');

        var gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
        gradient.addColorStop(0, 'rgba(29, 185, 84, 0.8)');
        gradient.addColorStop(1, 'rgba(29, 185, 84, 0.2)');

        data.datasets[0].backgroundColor = gradient;
        data.datasets[0].borderColor = '#1db954';
        data.datasets[0].borderWidth = 1.5;

        new Chart(ctx, {
          type: 'bar',
          data: data,
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              tooltip: {
                backgroundColor: '#181818',
                borderColor: '#333',
                borderWidth: 1,
                titleColor: '#fff',
                callbacks: {
                  label: function(ctx) {
                    return ctx.parsed.y + ' hours';
                  }
                }
              }
            },
            scales: {
              x: {
                ticks: { color: '#b3b3b3' },
                grid: { color: 'rgba(255,255,255,0.05)' }
              },
              y: {
                ticks: {
                  color: '#b3b3b3'
                },
                grid: { color: 'rgba(255,255,255,0.08)' }
              }
            }
          }
        });
      }

      var script = document.createElement('script');
      script.src = "https://cdn.jsdelivr.net/npm/chart.js";
      script.defer = true;
      script.onload = renderMonthlyChart;
      document.head.appendChild(script);
    })();
  </script>
<% end %>
