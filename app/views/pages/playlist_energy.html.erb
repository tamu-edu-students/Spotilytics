<main class="container listening-patterns mt-4">
  <div class="page-heading d-flex flex-column flex-lg-row align-items-lg-center justify-content-lg-between">
    <div>
      <p class="eyebrow text-uppercase mb-1">Playlist Energy</p>
      <h1 class="text-light mb-2">Energy Rollercoaster</h1>
      <p class="text-secondary mb-0">
        We plot the energy score of each track in playlist order so you can see build-ups, dips, and drops.
      </p>
    </div>

    <div class="d-flex align-items-center gap-2 mt-3 mt-lg-0">
      <div class="total-chip text-light">
        <span class="label text-secondary">Tracks analyzed</span>
        <span class="value text-light"><%= @points.size %></span>
      </div>
    </div>
  </div>

  <% if @points.present? %>
    <div class="spotify-card p-3 mt-4">
      <div class="d-flex justify-content-between align-items-start mb-2">
        <div>
          <h5 class="text-light mb-1">Energy by track</h5>
          <p class="text-secondary small mb-0">
            Playlist ID: <code><%= @playlist_id %></code>
          </p>
        </div>
        <span class="badge bg-success-subtle text-success-emphasis">Live from Spotify</span>
      </div>

      <div class="chart-wrapper">
        <canvas id="energyChart" height="320" aria-label="Playlist energy chart" role="img"></canvas>
      </div>
      <p class="text-secondary small mt-2 mb-0">
        Energy values are 0–100. Higher = more intense; lower = mellower.
      </p>
    </div>

    <div class="spotify-card p-3 mt-3">
      <h6 class="text-light mb-2">Track order</h6>
      <div class="row g-2">
        <% @points.each do |point| %>
          <div class="col-12 col-md-6 col-lg-4">
            <div class="recent-card p-2 d-flex justify-content-between align-items-center">
              <div>
                <p class="text-light fw-semibold mb-1"><%= point[:label] %></p>
                <p class="text-secondary small mb-0"><%= point[:track].artists %></p>
              </div>
              <span class="badge bg-light-subtle text-dark-emphasis">
                <%= point[:energy].present? ? "#{point[:energy]}%" : "N/A" %>
              </span>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  <% else %>
    <div class="spotify-card p-4 mt-4">
      <h5 class="text-light">No energy data yet</h5>
      <p class="text-secondary mb-2">
        We couldn’t load tracks for that playlist. Double-check the playlist ID and try again.
      </p>
    </div>
  <% end %>
</main>

<% if @points.present? %>
  <script type="application/json" id="energyData"><%= raw({ labels: @labels, energies: @energies, points: @points.size }.to_json) %></script>
  <script>
    (function() {
      function renderEnergyChart() {
        var canvas = document.getElementById('energyChart');
        if (!canvas) { return; }
        if (!window.Chart) { return setTimeout(renderEnergyChart, 50); }

        var rawData = JSON.parse(document.getElementById('energyData').textContent);
        
        // Debug: Log the data
        console.log('Energy chart data:', rawData);
        console.log('Labels:', rawData.labels);
        console.log('Energies:', rawData.energies);
        
        var ctx = canvas.getContext('2d');

        var gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
        gradient.addColorStop(0, 'rgba(29, 185, 84, 0.8)');
        gradient.addColorStop(1, 'rgba(29, 185, 84, 0.1)');

        var chartData = {
          labels: rawData.labels,  // Use numeric positions 1, 2, 3...
          datasets: [{
            label: 'Energy',
            data: rawData.energies,
            borderColor: '#1db954',
            backgroundColor: gradient,
            fill: true,
            tension: 0.45,
            cubicInterpolationMode: 'monotone',
            spanGaps: false,
            borderWidth: 2,
            pointRadius: 4,
            pointBackgroundColor: '#1db954'
          }]
        };

        new Chart(ctx, {
          type: 'line',
          data: chartData,
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              tooltip: {
                backgroundColor: '#181818',
                borderColor: '#333',
                borderWidth: 1,
                titleColor: '#fff',
                callbacks: {
                  title: function(ctx) {
                    return 'Track #' + ctx[0].label;
                  },
                  label: function(ctx) {
                    var energy = ctx.parsed.y;
                    return energy !== null ? energy + '% energy' : 'No data';
                  }
                }
              }
            },
            scales: {
              x: {
                title: {
                  display: true,
                  text: 'Track Order',
                  color: '#b3b3b3'
                },
                ticks: { 
                  color: '#b3b3b3',
                  autoSkip: true,
                  maxTicksLimit: 20
                },
                grid: { color: 'rgba(255,255,255,0.05)' }
              },
              y: {
                title: {
                  display: true,
                  text: 'Energy Level',
                  color: '#b3b3b3'
                },
                min: 0,
                max: 100,
                ticks: { color: '#b3b3b3' },
                grid: { color: 'rgba(255,255,255,0.08)' }
              }
            }
          }
        });
      }

      var script = document.createElement('script');
      script.src = "https://cdn.jsdelivr.net/npm/chart.js";
      script.defer = true;
      script.onload = renderEnergyChart;
      document.head.appendChild(script);
    })();
  </script>
<% end %>
