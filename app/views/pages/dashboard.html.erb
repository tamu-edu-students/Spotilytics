<% content_for :extra_css do %>
  <%= stylesheet_link_tag "dashboard", media: "all" %>
<% end %>

<main class="container mt-4">
  <h1>Your Dashboard</h1>
  <div class="spotify-card p-3 me-3 mb-4">
    <h5 class="text-light mb-1">Top Tracks</h5>

    <% if @primary_track.present? %>
      <div class="d-flex align-items-center mb-3">
        <% if @primary_track.album_image_url.present? %>
          <%= image_tag @primary_track.album_image_url, 
                        alt: @primary_track.album_name, 
                        class: 'rounded border me-3', 
                        size: "72x72" %>
        <% end %>
        <div>
          <strong class="text-light fs-5"><%= @primary_track.name %></strong>
          <div class="text-secondary small"><%= @primary_track.artists %></div>
          <div class="text-secondary small">Album: <%= @primary_track.album_name %></div>
          <div class="text-secondary small">Popularity: <%= @primary_track.popularity %>/100</div>
        </div>
      </div>

      <% if @top_tracks.second.present? %>
        <ul class="list-unstyled text-secondary small mb-0">
          <% @top_tracks.first(5).each_with_index do |track, idx| %>
            <li class="d-flex align-items-start">
              <span class="badge bg-secondary me-2">#<%= idx + 1 %></span>
              <div>
                <span class="text-light"><%= track.name %></span>
                <div class="text-secondary small"><%= track.artists %></div>
              </div>
            </li>
          <% end %>
        </ul>
      <% end %>
    <% end %>

    <div class="mt-3">
      <%= link_to 'View top 10 tracks this year', top_tracks_path , class: 'btn btn-spotify' %>
    </div>
  </div>
  <div class="spotify-card p-3 me-3 mb-4">
  <h5 class="text-light mb-1">Top Artists & Genres</h5>

  <div class="row g-4 align-items-start">

    <div class="col-12 col-lg-6">
      <% if @primary_artist.present? %>
        <div class="d-flex align-items-center mb-3">
          <% if @primary_artist.image_url.present? %>
            <%= image_tag @primary_artist.image_url,
                          alt: @primary_artist.name,
                          class: 'rounded-circle border me-3',
                          size: "72x72" %>
          <% end %>
          <div>
            <strong class="text-light fs-5"><%= @primary_artist.name %></strong>
            <div class="text-secondary small">Plays: <%= @primary_artist.playcount %></div>
          </div>
        </div>

        <% if @top_artists.second.present? %>
          <ul class="list-unstyled text-secondary small mb-0">
            <% @top_artists.first(5).each_with_index do |artist, idx| %>
              <li class="mb-1">
                <span class="badge bg-secondary me-2">#<%= idx + 1 %></span>
                <%= artist.name %>
              </li>
            <% end %>
          </ul>
        <% end %>
      <% else %>
        <p class="text-secondary mb-3">
          We couldn't load your top artists right now. Please try again soon.
        </p>
      <% end %>

      <div class="mt-3">
        <%= link_to 'View Top Artists', top_artists_path, class: 'btn btn-spotify btn-sm' %>
      </div>
    </div>

    <div class="col-12 col-lg-6">
      <% if @genre_chart.present? %>
        <div class="d-flex flex-wrap align-items-start gap-3">
          <div class="flex-shrink-0">
            <canvas id="genrePie" width="220" height="220"
                    aria-label="Top genres chart" role="img"></canvas>

            <!-- No-JS static pie fallback -->
            <% colors = spotify_colors %>
            <noscript>
              <% total = @genre_chart[:datasets][0][:data].sum.to_f %>
              <% start_angle = 0.0 %>
              <% gradient_segments = @genre_chart[:datasets][0][:data].map.with_index do |val, i|
                  pct = total.zero? ? 0.0 : val.to_f / total
                  end_angle = start_angle + (pct * 360.0)
                  color = colors[i % colors.length]
                  seg = "#{color} #{start_angle.round(1)}deg #{end_angle.round(1)}deg"
                  start_angle = end_angle
                  seg
                end.join(', ') %>

              <div class="static-pie" style="
                  width: 260px; height: 260px;
                  border-radius: 50%;
                  background: conic-gradient(<%= gradient_segments.html_safe %>);
                  border: 1px solid rgba(255,255,255,0.1);
                ">
              </div>
            </noscript>
          </div>

          <div class="flex-grow-1">
            <ul class="list-unstyled mt-1 small">
              <% @genre_chart[:labels].each_with_index do |label, i| %>
                <li class="text-secondary mb-1">
                  <span class="text-light fw-semibold"><%= label %></span>
                  â€” <%= @genre_chart[:datasets][0][:data][i] %>
                </li>
              <% end %>
            </ul>
          </div>
        </div>
      <% else %>
        <p class="text-secondary mb-0">No genre data available.</p>
      <% end %>
    </div>

  </div>
</div>

<%# Load Chart.js and render ONLY if data present %>
<% if @genre_chart.present? %>
  <!-- The exact same palette used by <noscript> -->
  <script type="application/json" id="genreData"><%= raw(@genre_chart.to_json) %></script>
  <script type="application/json" id="genreColors"><%= raw(spotify_colors.to_json) %></script>

  <!-- Load Chart.js, then render -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"
          onload="renderGenreChart()"
          defer></script>

  <script>
    function renderGenreChart() {
      if (!document.getElementById('genrePie')) {
        return document.addEventListener('DOMContentLoaded', renderGenreChart, { once: true });
      }
      if (!window.Chart) { return setTimeout(renderGenreChart, 0); }

      var canvas = document.getElementById('genrePie');
      var ctx    = canvas.getContext('2d');

      var data   = JSON.parse(document.getElementById('genreData').textContent);
      var colors = JSON.parse(document.getElementById('genreColors').textContent);

      data.datasets[0].backgroundColor = data.labels.map(function(_, i){ return colors[i % colors.length]; });
      data.datasets[0].borderColor = '#101010';
      data.datasets[0].borderWidth = 1;

      new Chart(ctx, {
        type: 'pie',
        data: data,
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              backgroundColor: '#181818',
              titleColor: '#FFFFFF',
              borderColor: '#333',
              borderWidth: 1,
              callbacks: { label: function(c){ return c.label + ': ' + c.parsed; } }
            }
          }
        }
      });
    }
  </script>
<% end %>
</main>
